<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สูตรอาหาร</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Noto Serif Thai', serif;
            background-color: #9b4022;
            background-image: url('img/bg5.png');
            background-size: 100%;
        }
        .navbar {
            background-color: #F8F1E5;
            display: flex;
            align-items: center;
            justify-content: center;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background-size:contain;
        }

        .navbar img.logo {
            height: 70px;
        }
        .navbar .search-box {
            width: 300px;
            margin: 0 20px;
            display: flex;
            align-items: center;
            border-radius: 20px;
            padding: 5px 10px;
        }
        .navbar .nav-links {
            display: flex;
            align-items: center;
        }
        .navbar .nav-links a {
            text-decoration: none;
            color: #000;
            margin-left: 20px; 
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .navbar .nav-links img.icon {
            margin-right: 5px;
            height: 24px;
        }
        .navbar .nav-links a.login {
            color: red;
        }
        /* Recipe styles */
        .recipe-container {
            max-width: 1000px;
            margin: 0px auto;
            padding: 20px;
            background-color: #fcf4ce;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .recipe-image {
            flex: 1;
            max-width: 45%;
            margin-right: 20px;
        }

        .recipe-image img {
            width: 100%;
            height: auto;
        }

        .recipe-details {
            flex: 1;
            max-width: 45%;
        }

        .recipe-details h1 {
            color: #000;
            font-size: 25px;
            margin-bottom: 10px;
        }

        .recipe-details .rating {
            margin-bottom: 10px;
            line-height: 1.6; /* เพิ่มระยะห่างระหว่างบรรทัด */
        }

        .recipe-details .rating span {
            font-size: 18px;
        }

        .recipe-details .rating p {
            margin: 0 ;
        }

        .recipe-details h2 {
            color: black;
            font-size: 20px;
            margin-top: 20px;
        }

        .recipe-details ul {
            list-style-type: none;
            padding: 0;
        }

        .recipe-details ul li {
            margin-bottom: 10px;
        }

        .steps {
            max-width: 1000px;
            margin: 0px auto;
            padding: 20px;
            background-color: #ffffff;
        }

        .steps h2 {
            color: #000;
            font-size: 20px;
            margin-top: 0; /* ให้วิธีทำอยู่ด้านบน */
            margin-bottom: 10px;
        }

        /* ลบจุดนำหน้าขั้นตอนการทำ */
        #steps-list div {
            list-style: none;
            margin-bottom: 10px;
        }

        /* Navbar profile picture */
        .navbar .profile-pic {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 5px;
        }
        .comments-section {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
        }

        .comment-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .star-rating {
            display: flex;
            flex-direction: row;
            margin-bottom: 10px;
        }
        
        .star-rating input[type="radio"] {
            display: none;
        }
        
        .star-rating label {
            font-size: 25px;
            color: #ddd;
            cursor: pointer;
        }
        
        .star-rating label:hover,
        .star-rating label:hover ~ label,
        .star-rating input[type="radio"]:checked ~ label {
            color: #ffd700;
        }
        
        /* สลับทิศทางของ hover effect */
        .star-rating {
            direction: rtl;
        }
        
        .star-rating label {
            direction: ltr;
        }

        .comment-input {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .comment-submit {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .comment-submit:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .comment-submit:hover:not(:disabled) {
            background-color: #45a049;
        }

        .comments-list {
            margin-top: 20px;
        }

        .comment-item {
            background-color: #ffffff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-stars {
            color: #ffd700;
            letter-spacing: 2px;
        }

        .comment-text {
            margin: 8px 0;
            line-height: 1.4;
        }

        .comment-user {
            font-weight: bold;
            color: black;
        }

        .comment-date {
            color: #666;
            font-size: 0.85em;
        }

        
    </style>
</head>
<body>
    <div class="navbar">
        <img src="img/logo.png" alt="Logo" class="logo">
        <!-- Search Box -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ค้นหา">
        </div>

        <script>
            // จับเหตุการณ์เมื่อผู้ใช้กด Enter ในช่องค้นหา
            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {  // ตรวจสอบว่าเป็นปุ่ม Enter หรือไม่
                    const query = e.target.value.trim();  // รับค่าที่กรอกในช่องค้นหา
                    if (query) {
                        // ย้ายไปหน้า search.html พร้อมส่งค่าคำค้นหาเป็น query string
                        window.location.href = `search.html?query=${encodeURIComponent(query)}`;
                    }
                }
            });
        </script>
        <!-- Navigation Links -->
        <div class="nav-links">
            <a href="index.html"><img src="img/homeicon.png" alt="หน้าแรก" class="icon">หน้าแรก</a>
            <a href="indexmaindish.html"><img src="img/foodicon.png" alt="สูตรอาหารคาว" class="icon" onclick="location.href='indexmaindish.html'">สูตรอาหารคาว</a>
            <a href="indexdessert.html"><img src="img/desserticon.png" alt="สูตรของหวาน" class="icon" onclick="location.href='indexdessert.html'">สูตรของหวาน</a>
            <a href="login.html"><img src="img/recomendicon.png" alt="แนะนำสูตร" class="icon" onclick="location.href='login.html'">แนะนำสูตร</a>
            <a href="notification.html"><img src="img/noti.png" alt="การแจ้งเตือน" class="icon" onclick="location.href='notification.html'"></a>
            <a href="login.html" class="login"><img src="img/usericon.png" alt="เข้าสู่ระบบ" class="icon" onclick="location.href='login.html'">เข้าสู่ระบบ</a>
        </div>
    </div>

</body>
</html>

    <!-- Recipe Content -->
    <div class="recipe-container">
        <div class="recipe-image">
            <img id="recipe-image" src="" alt="รูปอาหาร">
        </div>
        <div class="recipe-details">
            <h1 id="recipe-name">
                <span id="recipe-title">ชื่อสูตร</span>
                
            </h1>
            <div class="rating">
                <p id="recipe-rating">⭐</p>
                <p id="recipe-source">สร้างโดย </p>
                <p id="recipe-date">วันที่สร้าง </p>
                <p id="recipe-updated-date" style="display: none;">วันที่ปรับปรุง </p>
            </div>
            
            <h2>วัตถุดิบ</h2>
            <ul id="ingredients-list"></ul>
        </div>
        
    </div>
    <div class="steps">
        <h2>วิธีทำ</h2>
        <div id="steps-list"></div> <!-- เปลี่ยนจาก ul เป็น div -->
    </div>

    <div class="comments-section">
        <h2>แสดงความคิดเห็น</h2>
        <div class="comment-form">
            <div class="star-rating">
                <input type="radio" id="star1" name="rating" value="5">
                <label for="star1">★</label>
                <input type="radio" id="star2" name="rating" value="4">
                <label for="star2">★</label>
                <input type="radio" id="star3" name="rating" value="3">
                <label for="star3">★</label>
                <input type="radio" id="star4" name="rating" value="2">
                <label for="star4">★</label>
                <input type="radio" id="star5" name="rating" value="1">
                <label for="star5">★</label>
            </div>
            <textarea class="comment-input" placeholder="เขียนความคิดเห็นของคุณที่นี่..."></textarea>
            <button type="button" class="comment-submit" disabled>ส่งความคิดเห็น</button>
        </div>
        <div class="comments-list">
            <!-- ความคิดเห็นจะถูกเพิ่มที่นี่ด้วย JavaScript -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const commentForm = document.querySelector('.comment-form');
            const commentInput = document.querySelector('.comment-input');
            const submitButton = document.querySelector('.comment-submit');
            const ratingInputs = document.querySelectorAll('input[name="rating"]');
        
            // ดึงค่า recipe_id จาก URL
            const urlParams = new URLSearchParams(window.location.search);
            const recipeId = urlParams.get('recipe_id');
        
            if (!recipeId) {
                alert('ไม่พบ ID ของสูตรอาหาร');
                return;
            }
        
            // ฟังก์ชันตรวจสอบการกรอกข้อมูล
            function checkFormValidity() {
                const rating = document.querySelector('input[name="rating"]:checked');
                const comment = commentInput.value.trim();
                submitButton.disabled = !rating || !comment;
            }
        
            // ตรวจสอบการล็อกอินก่อนแสดงฟอร์มความคิดเห็น
            fetch('check_session.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.logged_in) {
                        commentForm.innerHTML = `
                            <p>
                                กรุณาเข้าสู่ระบบก่อนแสดงความคิดเห็น 
                                <a href="login.html" style="color: blue; text-decoration: underline;">เข้าสู่ระบบ</a>
                            </p>
                        `;
                        return;
                    }
        
                    // ฟังก์ชันโหลดความคิดเห็น
                    function loadComments() {
                        fetch(`get_comments.php?recipe_id=${recipeId}`)
                            .then(response => response.json())
                            .then(comments => {
                                const commentsList = document.querySelector('.comments-list');
                                commentsList.innerHTML = '';
        
                                if (!comments || comments.error || comments.length === 0) {
                                    commentsList.innerHTML = '<p>ยังไม่มีความคิดเห็น</p>';
                                    return;
                                }
        
                                comments.forEach(comment => {
                                    const stars = '⭐'.repeat(parseInt(comment.rating));
                                    const commentDate = new Date(comment.created_at).toLocaleDateString('th-TH', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
        
                                    const commentHtml = `
                                        <div class="comment-item">
                                            <div class="comment-header">
                                                <span class="comment-user">${comment.username}</span>
                                                <span class="comment-stars">${stars}</span>
                                            </div>
                                            <div class="comment-text">${comment.comment_text}</div>
                                            <small class="comment-date">${commentDate}</small>
                                        </div>
                                    `;
                                    commentsList.insertAdjacentHTML('beforeend', commentHtml);
                                });
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                document.querySelector('.comments-list').innerHTML = 
                                    '<p>เกิดข้อผิดพลาดในการโหลดความคิดเห็น</p>';
                            });
                    }
        
                    // โหลดความคิดเห็นตั้งแต่เริ่มต้น
                    loadComments();
        
                    // จัดการการส่งความคิดเห็น
                    submitButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        const rating = document.querySelector('input[name="rating"]:checked');
                        const comment = commentInput.value.trim();
        
                        if (!rating || !comment) {
                            alert('กรุณาให้คะแนนและเขียนความคิดเห็น');
                            return;
                        }
        
                        fetch('save_comment.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recipe_id: recipeId,
                                rating: rating.value,
                                comment: comment
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                document.getElementById('recipe-rating').innerText =
                                    `${'⭐'.repeat(Math.round(data.avg_rating))} (${data.avg_rating})`;
                                commentInput.value = '';
                                document.querySelector('input[name="rating"]:checked').checked = false;
                                submitButton.disabled = true;
                                loadComments();
                                alert('บันทึกความคิดเห็นเรียบร้อยแล้ว');
                            } else {
                                alert(data.error || 'เกิดข้อผิดพลาดในการบันทึกความคิดเห็น');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('เกิดข้อผิดพลาดในการส่งข้อมูล');
                        });
                    });
        
                    // ตั้งเวลาโหลดความคิดเห็นใหม่ทุก 30 วินาที
                    setInterval(() => loadComments(), 30000);
        
                    // ติดตามการเปลี่ยนแปลงของ input
                    commentInput.addEventListener('input', checkFormValidity);
                    ratingInputs.forEach(input => input.addEventListener('change', checkFormValidity));
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('เกิดข้อผิดพลาดในการตรวจสอบสถานะการเข้าสู่ระบบ');
                });
        });
        </script>
        

    <script>
        // ดึงค่า recipe_id จาก URL
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('recipe_id');
    
        // ฟังก์ชันสำหรับแปลงวันที่เป็นภาษาไทยโดยไม่แสดงเวลา
        function formatDateThai(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('th-TH', options);
        }

    
        if (recipeId) {
            fetch(`get_recipes.php?recipe_id=${recipeId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('เกิดข้อผิดพลาด: ' + data.error);
                    } else {
                        // ตั้งค่าชื่อสูตรและข้อมูลอื่นๆ
                        document.getElementById('recipe-title').innerText = data.recipe_name;
                        document.getElementById('recipe-rating').innerText += data.rating;
                        document.getElementById('recipe-source').innerText += " " + data.source;
                        document.getElementById('recipe-date').innerText += formatDateThai(data.created_at);
                        document.getElementById('recipe-image').src = data.image_path;
    

                        // แสดงวันที่ปรับปรุง (ถ้ามี)
                        if (data.updated_at) {
                            const updatedDateElement = document.getElementById('recipe-updated-date');
                            updatedDateElement.innerText += formatDateThai(data.updated_at);
                            updatedDateElement.style.display = "block";
                        }

    
                        // เพิ่มวัตถุดิบ
                        data.ingredients.split('\n').forEach(item => {
                            const li = document.createElement('li');
                            li.innerText = item.trim();
                            document.getElementById('ingredients-list').appendChild(li);
                        });
    
                        // เพิ่มขั้นตอนการทำ
                        data.steps.split('\n').forEach(step => {
                            const div = document.createElement('div');
                            div.innerText = step.trim();
                            document.getElementById('steps-list').appendChild(div);
                        });
                    }
                })
                .catch(error => console.error('เกิดข้อผิดพลาด:', error));
        } else {
            alert('ไม่พบ ID ของสูตรอาหาร');
        }
    </script>



</body>
</html>
